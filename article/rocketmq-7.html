<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RocketMQ系列（七）事务消息 | 牛初九博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="Java 技术 互联网 Spring Redis Mysql ">
    <meta name="keywords" content="Java 技术 互联网 Spring SpringBoot SpringCloud Elastic Search MySQL MyCAT 分布式 集群">
    
    <link rel="preload" href="/assets/css/0.styles.fab77d47.css" as="style"><link rel="preload" href="/assets/js/app.16ffb530.js" as="script"><link rel="preload" href="/assets/js/2.2805d820.js" as="script"><link rel="preload" href="/assets/js/14.fe8172bf.js" as="script"><link rel="prefetch" href="/assets/js/10.7af0fa3b.js"><link rel="prefetch" href="/assets/js/11.bf2b4ef3.js"><link rel="prefetch" href="/assets/js/12.ffa316c1.js"><link rel="prefetch" href="/assets/js/13.7bf9e28b.js"><link rel="prefetch" href="/assets/js/15.12492866.js"><link rel="prefetch" href="/assets/js/16.1e0b9828.js"><link rel="prefetch" href="/assets/js/17.5274e857.js"><link rel="prefetch" href="/assets/js/18.14c495e2.js"><link rel="prefetch" href="/assets/js/19.0065f7d5.js"><link rel="prefetch" href="/assets/js/20.15195b8f.js"><link rel="prefetch" href="/assets/js/21.a49d2486.js"><link rel="prefetch" href="/assets/js/22.7625f3ea.js"><link rel="prefetch" href="/assets/js/23.6829be75.js"><link rel="prefetch" href="/assets/js/24.d89bf6ba.js"><link rel="prefetch" href="/assets/js/25.f9c8e982.js"><link rel="prefetch" href="/assets/js/26.df00cb25.js"><link rel="prefetch" href="/assets/js/27.c2c39573.js"><link rel="prefetch" href="/assets/js/28.9d6955a7.js"><link rel="prefetch" href="/assets/js/29.793a5925.js"><link rel="prefetch" href="/assets/js/3.99170183.js"><link rel="prefetch" href="/assets/js/30.1d4eb018.js"><link rel="prefetch" href="/assets/js/31.c3635b83.js"><link rel="prefetch" href="/assets/js/32.39f76767.js"><link rel="prefetch" href="/assets/js/33.9623bd00.js"><link rel="prefetch" href="/assets/js/34.685b37ce.js"><link rel="prefetch" href="/assets/js/35.b6d262de.js"><link rel="prefetch" href="/assets/js/36.706cce0c.js"><link rel="prefetch" href="/assets/js/37.4b559cf9.js"><link rel="prefetch" href="/assets/js/38.8440f0a1.js"><link rel="prefetch" href="/assets/js/39.89829fe9.js"><link rel="prefetch" href="/assets/js/4.44e35b71.js"><link rel="prefetch" href="/assets/js/40.1eae592a.js"><link rel="prefetch" href="/assets/js/41.307e59e5.js"><link rel="prefetch" href="/assets/js/42.9c9598a9.js"><link rel="prefetch" href="/assets/js/43.6de9381c.js"><link rel="prefetch" href="/assets/js/44.0bda172b.js"><link rel="prefetch" href="/assets/js/45.7bd4678e.js"><link rel="prefetch" href="/assets/js/46.9601296c.js"><link rel="prefetch" href="/assets/js/47.8279d007.js"><link rel="prefetch" href="/assets/js/48.e8ae43c5.js"><link rel="prefetch" href="/assets/js/49.088eb890.js"><link rel="prefetch" href="/assets/js/5.7b7d1525.js"><link rel="prefetch" href="/assets/js/50.a104d084.js"><link rel="prefetch" href="/assets/js/51.0c101ee6.js"><link rel="prefetch" href="/assets/js/52.4269f250.js"><link rel="prefetch" href="/assets/js/53.1c55a938.js"><link rel="prefetch" href="/assets/js/54.dab6fc62.js"><link rel="prefetch" href="/assets/js/55.18a1bf4c.js"><link rel="prefetch" href="/assets/js/56.b2c0ee59.js"><link rel="prefetch" href="/assets/js/57.0a78afcc.js"><link rel="prefetch" href="/assets/js/58.d75522d5.js"><link rel="prefetch" href="/assets/js/59.2543ea7e.js"><link rel="prefetch" href="/assets/js/6.6d27b31c.js"><link rel="prefetch" href="/assets/js/60.16f65788.js"><link rel="prefetch" href="/assets/js/61.d6e2d8b6.js"><link rel="prefetch" href="/assets/js/62.183c4095.js"><link rel="prefetch" href="/assets/js/63.920617f0.js"><link rel="prefetch" href="/assets/js/64.5b2731e6.js"><link rel="prefetch" href="/assets/js/65.56420cc0.js"><link rel="prefetch" href="/assets/js/66.2ebd0c92.js"><link rel="prefetch" href="/assets/js/67.a414b285.js"><link rel="prefetch" href="/assets/js/68.989dacce.js"><link rel="prefetch" href="/assets/js/69.79a844b9.js"><link rel="prefetch" href="/assets/js/7.fee5c0b2.js"><link rel="prefetch" href="/assets/js/70.b789f7cb.js"><link rel="prefetch" href="/assets/js/71.90a71409.js"><link rel="prefetch" href="/assets/js/72.0dee4533.js"><link rel="prefetch" href="/assets/js/73.72b757a5.js"><link rel="prefetch" href="/assets/js/74.5cc6a8e7.js"><link rel="prefetch" href="/assets/js/75.a3efa729.js"><link rel="prefetch" href="/assets/js/76.ee52fbb0.js"><link rel="prefetch" href="/assets/js/77.2c257317.js"><link rel="prefetch" href="/assets/js/78.831d9b7b.js"><link rel="prefetch" href="/assets/js/79.7940520a.js"><link rel="prefetch" href="/assets/js/8.7f9f9c54.js"><link rel="prefetch" href="/assets/js/80.2f951622.js"><link rel="prefetch" href="/assets/js/81.fb674315.js"><link rel="prefetch" href="/assets/js/82.b9069b51.js"><link rel="prefetch" href="/assets/js/83.d718aedc.js"><link rel="prefetch" href="/assets/js/84.95180f04.js"><link rel="prefetch" href="/assets/js/85.3253eaff.js"><link rel="prefetch" href="/assets/js/86.3663d770.js"><link rel="prefetch" href="/assets/js/87.0c11349f.js"><link rel="prefetch" href="/assets/js/88.f5fac9dc.js"><link rel="prefetch" href="/assets/js/89.5e9c86e8.js"><link rel="prefetch" href="/assets/js/9.759c07c6.js"><link rel="prefetch" href="/assets/js/90.faeb161a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fab77d47.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">牛初九博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/gzh/gzh.html" class="nav-link">
  公众号
</a></div><div class="nav-item"><a href="/es/es.html" class="nav-link">
  ES系列
</a></div><div class="nav-item"><a href="/rocket/rocket.html" class="nav-link">
  RocketMQ系列
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="慕课课程" class="dropdown-title"><span class="title">慕课课程</span> <span class="arrow down"></span></button> <button type="button" aria-label="慕课课程" class="mobile-dropdown-title"><span class="title">慕课课程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://coding.imooc.com/class/341.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  精讲分布式定时任务
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://class.imooc.com/sale/javaarchitect" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java架构师直通车
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/gzh/gzh.html" class="nav-link">
  公众号
</a></div><div class="nav-item"><a href="/es/es.html" class="nav-link">
  ES系列
</a></div><div class="nav-item"><a href="/rocket/rocket.html" class="nav-link">
  RocketMQ系列
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="慕课课程" class="dropdown-title"><span class="title">慕课课程</span> <span class="arrow down"></span></button> <button type="button" aria-label="慕课课程" class="mobile-dropdown-title"><span class="title">慕课课程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://coding.imooc.com/class/341.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  精讲分布式定时任务
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://class.imooc.com/sale/javaarchitect" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java架构师直通车
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/article/nacos.html" class="sidebar-link">注册中心Nacos集群搭建</a></li><li><a href="/article/nacos-1.html" class="sidebar-link">Nacos配置中心和服务的注册发现</a></li><li><a href="/article/login.html" class="sidebar-link">怎样实现登录？| Cookie or JWT</a></li><li><a href="/article/oauth.html" class="sidebar-link">OAuth授权</a></li><li><a href="/article/sso.html" class="sidebar-link">SSO单点登录流程</a></li><li><a href="/article/front-back.html" class="sidebar-link">前后端分离 | 登录状态</a></li><li><a href="/article/MySQL+Keepalived.html" class="sidebar-link">MySQL+Keepalived高可用</a></li><li><a href="/article/mysql-ms.html" class="sidebar-link">MySQL主从同步配置</a></li><li><a href="/article/mysql-huan.html" class="sidebar-link">MySQL中的幻读，你真的理解吗？</a></li><li><a href="/article/db-pool.html" class="sidebar-link">数据库连接池数量设置为多少？</a></li><li><a href="/article/CSRF.html" class="sidebar-link">CSRF的原理与防御</a></li><li><a href="/article/redis-lock.html" class="sidebar-link">Redis分布式锁</a></li><li><a href="/article/limit.html" class="sidebar-link">MySql分页查询慢</a></li><li><a href="/article/taglib.html" class="sidebar-link">自制权限框架（一）jsp标签</a></li><li><a href="/article/annotation.html" class="sidebar-link">自制权限框架（二）注解</a></li><li><a href="/article/jmeter-1.html" class="sidebar-link">JMeter测试（一）</a></li><li><a href="/article/jmeter-2.html" class="sidebar-link">JMeter测试（二）</a></li><li><a href="/article/spring-security.html" class="sidebar-link">Spring Security实现RBAC权限管理</a></li><li><a href="/article/nginx1.html" class="sidebar-link">Nginx简介（一）</a></li><li><a href="/article/nginx2.html" class="sidebar-link">Nginx简介（二）</a></li><li><a href="/article/string.html" class="sidebar-link">String是值传递还是引用传递</a></li><li><a href="/article/redis-cluster.html" class="sidebar-link">Redis集群</a></li><li><a href="/article/cas.html" class="sidebar-link">CAS与OAuth2的区别</a></li><li><a href="/article/spring-eureka-2.html" class="sidebar-link">Eureka服务注册与发现</a></li><li><a href="/article/spring-mobile.html" class="sidebar-link">Spring Mobile</a></li><li><a href="/article/es-1.html" class="sidebar-link">ES学习（一）ES的安装与启动</a></li><li><a href="/article/es-2.html" class="sidebar-link">ES学习（二）ES的集群原理</a></li><li><a href="/article/es-3.html" class="sidebar-link">ES学习（三）新建索引</a></li><li><a href="/article/es-4.html" class="sidebar-link">ES学习（四）字段类型（mapping）</a></li><li><a href="/article/es-5.html" class="sidebar-link">ES学习（五）动态映射</a></li><li><a href="/article/es-6.html" class="sidebar-link">ES学习（六）分析器</a></li><li><a href="/article/es-7.html" class="sidebar-link">ES学习（七）IK中文分词器</a></li><li><a href="/article/es-8.html" class="sidebar-link">ES学习（八）数据的增删改</a></li><li><a href="/article/es-9.html" class="sidebar-link">ES学习（九）搜索</a></li><li><a href="/article/es-10.html" class="sidebar-link">ES学习（十）聚合查询</a></li><li><a href="/article/es-11.html" class="sidebar-link">ES学习（十一）与SpringBoot结合</a></li><li><a href="/article/es-12.html" class="sidebar-link">ES学习（十二）高亮 和 搜索建议</a></li><li><a href="/article/es-13.html" class="sidebar-link">ES学习（十三）GEO位置搜索</a></li><li><a href="/article/rocketmq-1.html" class="sidebar-link">RocketMQ系列（一）基本概念</a></li><li><a href="/article/rocketmq-2.html" class="sidebar-link">RocketMQ系列（二）环境搭建</a></li><li><a href="/article/rocketmq-3.html" class="sidebar-link">RocketMQ系列（三）消息的生产与消费</a></li><li><a href="/article/rocketmq-4.html" class="sidebar-link">RocketMQ系列（四）顺序消费</a></li><li><a href="/article/rocketmq-5.html" class="sidebar-link">RocketMQ系列（五）广播与延迟消息</a></li><li><a href="/article/rocketmq-6.html" class="sidebar-link">RocketMQ系列（六）批量发送与过滤</a></li><li><a href="/article/rocketmq-7.html" aria-current="page" class="active sidebar-link">RocketMQ系列（七）事务消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/rocketmq-7.html#基础概念" class="sidebar-link">基础概念</a></li><li class="sidebar-sub-header"><a href="/article/rocketmq-7.html#落地案例" class="sidebar-link">落地案例</a></li><li class="sidebar-sub-header"><a href="/article/rocketmq-7.html#总结" class="sidebar-link">总结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rocketmq系列-七-事务消息"><a href="#rocketmq系列-七-事务消息" class="header-anchor">#</a> RocketMQ系列（七）事务消息</h1> <p>终于到了今天了，终于要讲RocketMQ最牛X的功能了，那就是<strong>事务消息</strong>。为什么事务消息被吹的比较热呢？近几年微服务大行其道，整个系统被切成了多个服务，每个服务掌管着一个数据库。那么多个数据库之间的数据一致性就成了问题，虽然有像XA这种强一致性事务的支持，但是这种强一致性在互联网的应用中并不适合，人们还是更倾向于使用最终一致性的解决方案，在最终一致性的解决方案中，使用MQ保证各个系统之间的数据一致性又是首选。</p> <p>RocketMQ为我们提供了事务消息的功能，它使得我们投放消息和其他的一些操作保持一个整体的原子性。比如：向数据库中插入数据，再向MQ中投放消息，把这两个动作作为一个原子性的操作。貌似其他的MQ是没有这种功能的。</p> <p>但是，纵观全网，讲RocketMQ事务消息的博文中，几乎没有结合数据库的，都是直接投放消息，然后讲解事务消息的几个状态，虽然讲的也没毛病，但是和项目中事务最终一致性的落地方案还相距甚远。包括我自己在内，在项目中，服务化以后，用MQ保证事务的最终一致性，在网上一搜，根本没有落地的方案，都是侃侃而谈。于是，我写下这篇博文，结合数据库，来谈一谈RocketMQ的事务消息到底怎么用。</p> <h2 id="基础概念"><a href="#基础概念" class="header-anchor">#</a> 基础概念</h2> <p>要使用RocketMQ的事务消息，要实现一个TransactionListener的接口，这个接口中有两个方法，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * When send transactional prepare(half) message succeed, this method will be invoked to execute local transaction.
     *
     * @param msg Half(prepare) message
     * @param arg Custom business parameter
     * @return Transaction state
     */</span>
<span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
     * When no response to prepare(half) message. broker will send check message to check the transaction status, and this
     * method will be invoked to get local transaction status.
     *
     * @param msg Check message
     * @return Transaction state
     */</span>
<span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>RocketMQ的事务消息是基于两阶段提交实现的，也就是说消息有两个状态，prepared和commited。当消息执行完send方法后，进入的prepared状态，进入prepared状态以后，就要执行executeLocalTransaction方法，这个方法的返回值有3个，也决定着这个消息的命运，</p> <ul><li>COMMIT_MESSAGE：提交消息，这个消息由prepared状态进入到commited状态，消费者可以消费这个消息；</li> <li>ROLLBACK_MESSAGE：回滚，这个消息将被删除，消费者不能消费这个消息；</li> <li>UNKNOW：未知，这个状态有点意思，如果返回这个状态，这个消息既不提交，也不回滚，还是保持prepared状态，而最终决定这个消息命运的，是checkLocalTransaction这个方法。</li></ul> <p>当executeLocalTransaction方法返回UNKNOW以后，RocketMQ会每隔一段时间调用一次checkLocalTransaction，这个方法的返回值决定着这个消息的最终归宿。那么checkLocalTransaction这个方法多长时间调用一次呢？我们在BrokerConfig类中可以找到，</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token comment">/**
  * Transaction message check interval.
  */</span>
<span class="token annotation punctuation">@ImportantField</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> transactionCheckInterval <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre></div><p>这个值是在brokder.conf中配置的，默认值是60*1000，也就是1分钟。那么会检查多少次呢？如果每次都返回UNKNOW，也不能无休止的检查吧，</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * The maximum number of times the message was checked, if exceed this value, this message will be discarded.
 */</span>
<span class="token annotation punctuation">@ImportantField</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> transactionCheckMax <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre></div><p>这个是检查的最大次数，超过这个次数，如果还返回UNKNOW，这个消息将被删除。</p> <p>事务消息中，TransactionListener这个最核心的概念介绍完后，我们看看代码如何写吧。</p> <h2 id="落地案例"><a href="#落地案例" class="header-anchor">#</a> 落地案例</h2> <p>我们在数据库中有一张表，具体如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>s_term<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>term_year<span class="token punctuation">`</span> <span class="token keyword">year</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span> <span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> 
</code></pre></div><p>字段的具体含义大家不用管，一会我们将向这张表中插入一条数据，并且向MQ中投放消息，这两个动作是一个原子性的操作，要么全成功，要么全失败。</p> <p>我们先来看看事务消息的客户端的配置，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;transactionProducer&quot;</span><span class="token punctuation">,</span>initMethod <span class="token operator">=</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionMQProducer</span> <span class="token function">transactionProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span>
        <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionMQProducer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.73.130:9876;192.168.73.131:9876;192.168.73.132:9876;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span><span class="token function">transactionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> producer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionListener</span> <span class="token function">transactionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们使用TransactionMQProducer生命生产者的客户端，并且生产者组的名字叫做TransactionMQProducer，后面NameServer的地址没有变化。最后就是设置了一个TransactionListener监听器，这个监听器的实现我们也定义了一个Bean，返回的是我们自定义的TransactionListenerImpl，我们看看里边怎么写的吧。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TermMapper</span> termMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Integer</span> termId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
        <span class="token class-name">Term</span> term <span class="token operator">=</span> termMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>termId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransaction termId=&quot;</span><span class="token operator">+</span>termId<span class="token operator">+</span><span class="token string">&quot; term:&quot;</span><span class="token operator">+</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> COMMIT_MESSAGE<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> termId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Term</span> term <span class="token operator">=</span> termMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>termId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;checkLocalTransaction termId=&quot;</span><span class="token operator">+</span>termId<span class="token operator">+</span><span class="token string">&quot; term:&quot;</span><span class="token operator">+</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;checkLocalTransaction：COMMIT_MESSAGE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> COMMIT_MESSAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;checkLocalTransaction：ROLLBACK_MESSAGE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ROLLBACK_MESSAGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个类中，我们要实现executeLocalTransaction和checkLocalTransaction两个方法，其中executeLocalTransaction是在执行完send方法后立刻执行的，里边我们根据term表的id去查询，如果能够查询出结果，就commit，消费端可以消费这个消息，如果查询不到，就返回一个UNKNOW，说明过一会会调用checkLocalTransaction再次检查。在checkLocalTransaction方法中，我们同样用termId去查询，这次如果再查询不到就直接回滚了。</p> <p>好了，事务消息中最重要的两个方法都已经实现了，我们再来看看service怎么写吧，</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">TermMapper</span> termMapper<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;transactionProducer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">TransactionMQProducer</span> producer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendTransactionMQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Term</span> term <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Term</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    term<span class="token punctuation">.</span><span class="token function">setTermYear</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    term<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> insert <span class="token operator">=</span> termMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token string">&quot;cluster-topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">setKeys</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;this is transaction mq &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TransactionSendResult</span> sendResult <span class="token operator">=</span> producer
        <span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> term<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;sendResult:&quot;</span><span class="token operator">+</span>sendResult<span class="token punctuation">.</span><span class="token function">getLocalTransactionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                       <span class="token operator">+</span><span class="token string">&quot; 时间：&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在sendTransactionMQ方法上，我们使用了@Transactional注解，那么在这个方法中，发生任何的异常，数据库事务都会回滚；</li> <li>然后，我们创建Term对象，向数据库中插入Term；</li> <li>构建Mesaage的信息，将termId作为message的key；</li> <li>使用sendMessageInTransaction发送消息，传入message和termId，<strong>这两个参数和executeLocalTransaction方法的入参是对应的。</strong></li></ul> <p>最后，我们在test方法中，调用sendTransactionMQ方法，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendTransactionMQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        transactionService<span class="token punctuation">.</span><span class="token function">sendTransactionMQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">600000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>整个生产端的代码就是这些了，消费端的代码没有什么变化，就不给大家贴出来了。接下来，我们把消费端的应用启动起来，<strong>消费端的应用最好不要包含生产端的代码，因为TransactionListener实例化以后，就会进行监听，而我们在消费者端是不希望看到TransactionListener中的日志的。</strong></p> <p>我们运行一下生产端的代码，看看是什么情况，日志如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>executeLocalTransaction <span class="token assign-left variable">termId</span><span class="token operator">=</span><span class="token number">15</span> term:com.example.rocketmqdemo.entity.Term@4a3509b0
sendResult:COMMIT_MESSAGE 时间：Wed Jun <span class="token number">17</span> 08:56:49 CST <span class="token number">2020</span>
</code></pre></div><ul><li>我们看到，先执行的是executeLocalTransaction这个方法，termId打印出来了，发送的结果也出来了，是COMMIT_MESSAGE，那么消费端是可以消费这个消息的；</li> <li>注意一下两个日志的顺序，先执行的executeLocalTransaction，说明在执行sendMessageInTransaction时，就会调用监听器中的executeLocalTransaction，它的返回值决定着这个消息是否真正的投放到队列中；</li></ul> <p>再看看消费端的日志，</p> <div class="language-shell extra-class"><pre class="language-shell"><code>msgs.size<span class="token punctuation">(</span><span class="token punctuation">)</span>:1
this is transaction mq Wed Jun <span class="token number">17</span> 08:56:49 CST <span class="token number">2020</span>
</code></pre></div><p>消息被正常消费，没有问题。那么数据库中有没有termId=15的数据呢？我们看看吧，</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhQAAAB9CAYAAAD6HvpeAAAeVElEQVR4nO3dfXAb95kf8C8oWXReLCF2qPgSJ5lQgBjTlqvwFFqAoyQ+m9CBVDtWG4k+X86m62Yh5mZk8BLOha3ttFXu2BumpzUzU4jwdUy7GdWW3Io3IwExEDt3kxEh8xyOW1l0aC7hc5zT+MTKgSTHI0aW0D92F1gsdoEFlnjl9zPDkYB9/2GBffb5vawjlUqlQURERGRDS613gIiIiBofAwoiIiKyjQEFERER2caAgoiIiGxjQEFERES2NURAsbS0VOtdoAL4+VAz4/lNZE1DBBRERERU3xhQEBERkW1ra70D9eLatWv47W9/i8uXL+Pq1atoaWnBRz7yEXzsYx9DSwvjrpW0a9euovM88MADeOCBB6qwN9X1iYE/t7X8byb/aoX2pDL0n+3x48cz///L6P80XObf+/+oovtUTX8yfsryvP9j//YK7snKacZjosooK6B4/vnn8dxzz+HKlSuW5r/uuutw//33o7+/v5zNVdxLL72EX/ziF7h27VretJaWFnzpS19CT09PDfasef385z83nbZjxw588MEHOHz4cFMGFatVMwUORJSvrICilGACAK5cuYIXXnihbgOKDz74AF/5yleQTsujkK9ZswZXr14FADgcDpw/fx7Ly8tobW2t5W4WFg/CJ+1HbLC91ntimSP4dN57afFhAMDDDz+Mp59+uumCinrPMFSKWXYCaK5A41O/egFPPfVUznsnTpxAX19fznvf+ta3AGzHy78O4w9uEaq4h6Wzekz46X/CBTBDsZqVFVDcf//9JQUVa9euxTe+8Y1yNlUVZ86cKTqPz+ezvsJ4EM49k5ZmHTiagtgDk4AgiZBvH3AoBu3b8aATxqufhHNE91b3KGZjg5AXjyPoHEPHbO76akUNHozceOONJQYVcQSdewC1PE1nC0KeTUR2tiRCvi7MDxdZdgW8cuYNvPmrdwAA9975Zfz63BJ++dY/Wlp28+c+iztvu9VgitHnanJMyRB8XcewW503GYJv3IWYuAkh3zhcMW25rJySgwb99yEZgvxV2IkXrexnPAjnWIfm3K8vTz31FI6dGbMUUCRDPnSNzBSYY0B3PmuWmx9GqtIntSr+H9F6+TKWd3yv6KzlHpN2+XFXrOLfVypNWQFFf39/3WYbytHS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" alt="image-20200617090229595"></p> <p>数据是有的，插入数据也是成功的。</p> <p>**这样使用就真的正确的吗？我们改一下代码看看，在service方法中抛个异常，让数据库的事务回滚，看看是什么效果。**改动代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendTransactionMQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    ……
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;数据库事务异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>抛出异常后，数据库的事务会回滚，那么MQ呢？我们再发送一个消息看看，</p> <p>生产端的日志如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>executeLocalTransaction <span class="token assign-left variable">termId</span><span class="token operator">=</span><span class="token number">16</span> term:com.example.rocketmqdemo.entity.Term@5d6b5d3d
sendResult:COMMIT_MESSAGE 时间：Wed Jun <span class="token number">17</span> 09:07:15 CST <span class="token number">2020</span>

java.lang.Exception: 数据库事务异常
</code></pre></div><ul><li>从日志中，我们可以看到，消息是投放成功的，termId=16，事务的返回状态是COMMIT_MESSAGE；</li> <li>最后抛出了我们定义的异常，那么数据库中应该是不存在这条消息的啊；</li></ul> <p>我们先看看数据库吧，</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYMAAAC9CAYAAABRYxF7AAAdx0lEQVR4nO3df3Cb9X0H8LecENMCiQo4sBbaqyPFxRAW3GAi0dBSaqWysx3ZmpgxCmasj2J6F+S2vs0b0Lulq2/nrnlw76ZYbIdhvQwStnh3iQRSge56sYKhPrYQU+PHopQ2R2NClYRycUOi/fE8j/To0fNIj2T9tN+vO59tPb+/evT9fH89X9kSiUQSAF555RWQsZtvvrnap0BUk5hvLB42NRgQEdHS1VDtEyAioupjMCAiIgYDIiJiMCAiIjAYEBER6iwYzM3NVfsUKAe+P7SYLfb7u66CARERlQeDARERYXm1T6DWXLhwAb///e9x9uxZnD9/Hg0NDfjYxz6GSy65BA0NjJ2ltGXLlrzr3H333bj77rsrcDaV9Ymev1nQ9r8b/acSnUl56N/bgwcPpv7+fvg/DLf5O+9flPWcKunrw0csr/vvOzeW8UysW1AweOaZZ/D000/j3Llzlta/6KKLcNddd6G7u3shhy2bF154AT//+c9x4cKFrGUNDQ246aab0NHRUYUzW7x+9rOfmS7btGkTPvzwQ+zdu3dRBoSlajFl+ovJgoJBIYEAAM6dO4dnn322ZoPBhx9+iC984QtIJuUZOpYtW4bz588DAGw2G06ePIn5+Xk0NjZW8zRzi/rhkXYi0ttc7TOxzOZ/Iuu1pHg/AOD+++/HE088segCQq2X7MvFrFYALK4gcdWvnsXjjz+e8dqhQ4fQ1dWV8do3vvENABvx4q+D+PI1QgXPMNuCgsFdd91VUEBYvnw5vva1ry3kkGV17NixvOt4PB7rO4z6Yd82amnVnv0JiB0wyczjCHh2AHsi0L4c9dthvPtR2Ad0L7UPYjLSC3nzKPz2IbRMZu6vWtSM38jll19eYECIwm/fBqjpabqaH/JqItKrxRHwtGG6P8+2JfDysTfw5q/eAQB85Zab8esTc/jFW7+0tO3aT1+LW66/zmCJ0ftqck3xADxtB7BVXTcegGfYgYi4BgHPMBwRbbqUTsEZvv7zEA9A/ihsxvNWzjPqh32oRXPv15bHH38cB44NWQoG8YAHbQMTOdbo0d3Pmu2m+5HIc1MvKBh0d3fXbCm/GA0NDYZNRNrlNpvN+g47RCQSIgAg6vdA2qn9kEbh90jYqbtJ49JU9n6iwziwdQ8iuru5Q0xA2b1m3fw1g6h/G0YBoM0OfcwA2jFY4SChrRkkxfth8z+RChCbNm3KWDdnMIgH4GkbwAQAbLMjO05qrq1DRCIRhd/ugZS63mb0RvbDb/cgUOY0aG/9HD48exa/PjGHn746iT+743acOPk+3j99Oud216xuQnvr5wyXxQNDGMWE5n3twf79wMAEMtNDKRhEEo7UtTqGBzAxCtjVlVJ/lOd+MKohlKJmYFZAatOXjjIKR+Vx6NAh09fUGkJ49kd48ddBy/tsH5w0+WzHEfAMG27T3BvBZMADT2BNznyBHcgaX/rSl2Cz2ZBMJvHRRx/hD3/4A1asWIHly5ejoaEByWSysGBQpFaH9g2Lwj/Ugj2RZhjWELQZYEpmzaBHU0qO+u3Yhh70AOjSlSLkZf0Vry3oawbq//r+BH1g0EqVmnoGMTg1gIHW/emSkJJGGNyju7YOiIkOufTYpstBNIHS/ANYPJvNhk3rb0Q49jISZz7AT45M4Csb2/FfL7yEj5SmST37ZZdi0/obje/BeAA7pvuRmJSUkrOc0UX9fuxPJICswgiQcf3Yj0SiA2qmUq6agSp/xi/XaOSC8Cjs0z3oGR2VA1r7oLLOKLapQasn/X735KsVVoi+SUjfTBSe/RFCknEGbmZioC271p/Sg/0mS5p792CrZwcCm80DOzuQNV588UUAcg1gxYoV+O53v5taNjAgvwM33nhjmY4uN2/It7ZcimsfnET/9BBa9kSUEkwzevdshWdHAJu1pRrNB0FfM4gHPFBvt3jAg6GWSSR6mwExCr/djkP7ExDXyJll6/4EElX4EBn1GejlakoC5NJPolf9rxe9UT/s9m3yv+2DmEwkMkqBUb8dQy1KJq+pwZnV2Mph+bJluGNDG8KxCbx/+jT+b0bClza04ScvZ39HwMcvvhh3bGjD8mXLDPYUR2DHNPojvQA6sGerBzsCmxHZ/DwOteyECADiHkgeP6IRER2ajFYOdGJF3vdV9tyjx04lDmr+a0ZvJIFe7f0sihCVZiKZcbMIkKsJFRWpFeRjFAgePrIh9ff3Nr5quF3emkHUD/uhLoMmoVlMT0xgdDiKXpNIyQ5kAxcuXMDZs2cBAMHpO/CFq3bi+4P/CBsacOLECYt70ZZsFKPZzTKjaphvH8RkYhItSqlsTcCDHQd2YNvEhOF2w9FeiB1R+JVagT3jxs+sGbQPxoGOZjT3RhBJnZ6EKQATmuaDVotXVmr5Mvr8DNK6Z386g48H4LHb07Wn9kFMRhLYE/DA7s/flmqF3W7Pei2RSOTdTs3kw7GX8Yu3fmnYb7B82TJ8ecNN+PjFF5vspRm9kXR7Yfp97oXYa7SONqM1yTi1N5S2sLEAmZl9AaaH4fF3IVLAOchNqHHE481obgZS9wgqFwiMmomA4moE+cnvbzzgQXvLzuzF0UMY7RnE4NQQAvEOw9oBO5A1brvtNpw4cQKnT59OBYNffXAEez84gssbm+Fe/SA+2/AnAKyMJlI+cMp/lvoM4gEcaO1CBEB0Gti6J5LVT6DsDPahAHZ29EJMJCDqlmX0GSgf+KwM06S0rBamS5UBWKHWDNT+AiO5A4aS1toms9FtugAJZLV/90aQP7u2JpFIZAQEK4FApTb//HTytdRINpXanPSJyy7Lsxf1fnJg2COha+sBbDPrbNS9t2rfUzzgwbAjIhcyylg7sv6cQRyBoVFMYBCTEcBvt5s2E6WbhtrRskbdfBbDO9owOiG/PjiZQKKC1QGjZiIAWe+xVc2btwJtuZqJALm2pL9IOR17+hPo7ZqG3aR2wA5kjfHxcaxevRqrVq3C6tWrM5a9Px/HwXe+g4sbdmH9qvvQZv8rXLJstcme9OIw6hfOMjuN1q5eZf1WOJoNSrwA5De8F7N+O/RN3TL9aKJR2A/IpeFe7cu6wGHYIV0B2ox+wbUETUYXD3iwA3tS1xf1eyBp11Wr1DulrH6XVI0tR1OEnhoQCgkEKrVj+OVjb2S8fnPr53DN6qaC97dG22xmcbjx7PQE4NC9aNrsUDxrHcVK/9jWHrRjM5rRLBd8LDQTTQ97YB/Vf2gmMKAdMFHBwo5ep0MuuYdnf1TYhs29iCR6DRdF/XYc6jLpK4kOyzWiDgDYicGhHYa1A3Yga3z00Uc4fvw4jh8/DgCGge7shVM48rthvJII4LpLt2LDJ3xoWmE0zE9rFtMTrejKVyrp6ALsdtgB+WYFIGWN5kiPGrA0mijjf6Pgog8c1R1NpNLXEiwHiawagbYk1Y5BTQ06emgUPV0i0Nyh+ZAtrFRcTCBQrf30tVnBoOXT1xa5N20fFJB+n03e36gf26YGMWlQGGhPFbVLJ/9oomb0RiJA1I8DUtaqJuRCVFdEhKi9Dl1AkzPO8geC3KOJsgOCWT+B8efWwGi65pQxjHzbKHr2J9L9jv2thrUDdiBrXHPNNTh+/HjO4aWq88lzeP3MPhw78yy+eOXf42a7ccQGlCF/Pf3IX+jugJjYD9i3YXRKQhz5PoT6D7xK32eg5oDapiujZxeUkSRVHk2U7/WcLNcMojg02oOuKtSEykrpC5IpJWdNgUCbBuow5njAg7YDWzUZyBq0YJsyHLMdg5PWboi9e/di7969hsvU6SnU6UUKHUaaMcbeaDRR+yAmIw5MowWbc+8IQ1OD2FOB9z3faCLrNQTN5zYegP/5zRB10dysZhD1b8PU4CQi2tc7ROw/ZIcnkNkZzQ5kjXvuuQcXLlzABx98gLNnz2J6etp03WW2iyzVDNIfNCslkfQDU5OSB21+YFBfvQWQHkLWUUCfQcZJpUYPiRn31CyMWgrKrRSjiVKs1gziEqZ6uiwE6HrRATHSgajfjtb+BJoR1S1/Hn77AEbVNIj60TYAtLe3Ybg/gUREu25mf5dV6jMgZgHBaJ4pbQ0hV4BIjRbL0UwUD3gwtXVP7hpdcy8ikVwrVFanYyfm5+ctP2sQn3WgZboNdk++jnClNtG6Xx49qNMhTkLytMGDdEBgB7JOQ0MDVq5ciZUrV8ov6DLSi5fZ8ccr/xJtq/4aly6/Kue+sktcOddGwDOElsmE8lBUBAnEEfAcMG0m0tKOCOnZr8niOsR0qUB9Ilrbeax7TqF9cLLiGeTCRxNp5GgLzigVP38ArV0RmNWuRjOrVlUfimhFarhsB5B6hiBlM8REb+q9jQ5PKfdVHAGPZuCAkQLa180CgtmEg+YBIN00knE/m4rj+QOt6NeMuNDWJtoHDUbYlFmuZiLV2NgYfvCDH1jeZ3NHB3o70rWE9Ge3B9pkivrbcGDrpGEgUPaE3sgkoAkItkQiUVzXdhXMzc2hqanwzrSFGJI+CQCwX/QZfN7+Day77C5c1PDxip5DvSj0/dmyZUvOier0Nm3alDH75WL02/ffx//OzOK37/8OAPB1bwHTn9QQbZNRvhqBqtbnJirk/v7Od75jeW6iQoJBObEDOY9PXbwBn7cLWHupFzYYPfBDC5HrqeKl6KrLL4fnlstTQaFeaTP/wmoEi4c8CV2msbGxKpyJNawZUMnw/aHFbLHf3/y2FiIiYjAgIiIGAyIiQp31GRARUXmwZkBEROmhpatWrbK80ezsLM6vKnbOlPqy7NQ7WLOm9HOz0NIxOzvLe6gEmI7lxZoBERExGBAREYMBERGBwYCIiMBgQEREYDAgIiLUSjCIS3g7bvm77YiIqMRKFAwkjHob0dL0RTz6QqHbPodHb7kenluuL2JbIiIqhdIEg3gI4VcB4AieCT1Xkl0SEVHllCYYNHfCe+9GrN+wEQPf/GpJdlnrJCkM0SciXO0TobrFe4hqSYm+6cyBnn/+H/SUZme1TxJxr7MPMQgIjVT7ZKgu8R6iGlMbHchERFRVFf8O5NSooWYHPlPpg1eRJCnX7XDAUfjGkPJtJ0mQcu1fXQ4HHAWfQHkUlSap6wAchV6IlXRclCSkk9r61S/onqW6U6KawXN4tKkRLU2NJiOCJIx++4toaWqERxk55GlqRPe3h/F2aU6gIiTRDZvNBpuzDzEAQBCdNpv8ms0GX1bjr4SwT97G6XTKPzYbbG4fRMORtGH4tPuSRLhtNticTjhtPqVtOXsdn1tZR9m/2yemMkwprNmH0wmnUz5+uMiRvGGfcr3u9DHyXseC0gSAFIboU9PemdrOprtW0+MbpmN1WLmHik9j/XWH5XvDpk+zcI79FvH+0KJQgWai5/Bo0/UYfOqI/O+GB9B97wNYvwF47al+eLyDmC7/SVRBGD63E51B+SPvEgQIggCXC0AsiD6nUUap2z6VYZiYFuF29iEIzb4BxIJ9cPrCkMI+ODv7EIMLgiBAUJYjFkSns7hM0XunoOxjHw6aZQ7hMQQBAALu9OquqYg0CQ91oi8YA+BKbSMoFxsL9sGZL9PMl441ZmFpnFoBPmcngjFNOitLYsFOkzRb6D1LdS2RSCQTiUSyEJIkJafn5jU//53sBpIAkt1Pa18/lhzYIL8OPJB8/OX5zO1eHkquh7pcv21t/EiSlJ0AM7uTLiAJCMmQSRqFBOW6XLuTM1mbu5Rr1m8fSgpKWrhcLsNttesASLp2Z66R3rfyI4Qy9xESUssEs5PPaSa522V87PQh0sc2fL2gNEkmQ4IrKYQMjpW6Flcy81SspGPlFH4PFZvGmfdG7nTOfv+LfX8qxTAdqWTKWzNIPX+wEQMv/wtua9Ytb96JZ55+oKynUBWSiF1BAHBh91P+rPZWh/8RyGW/IMZMSlqx2DqExrO3zeDajaf8mWuk9w0AAkIj3sx9ePuxWykiBs0OnpMDW7YrpfJ9Bw1Ll2PqtfdriqwLSBPvyDhGvAYpkbqWGPaZFKEtpWPNKTKNMwiG1+3wjyOk3CDBXZraQQnuWapvZQ0Gb0f+E68BwIY/x+36QKC640/RXc6TqALp4D65WUJ4BH7DXMgLtSXg6LRJO4BwJ8w+5irX9i0GmZwT16ntAYb7cKBlXZ4d5+HYsl1ucoj1YUifMajNF67t2KI5uZKkSZaZ/KtYSMdaVEwaa7l295ted7oZ6o1UCpbn/aF6UtbRRG/PKP0ErWuX0MghCQf3KS3UwV1wH91luFZMWSX2xgxgkKULxg3BGda15C7vuq5z5t1HURx+PCL0oTMo1y5GvOlzDctFVl2gKkGaSGGIB8fwxr6jOIpYat18rKRjTSo4jTPlvDec18EFIIajmJYAr6M09yzVtzIGAwnxKfmv9c6leuNYz7TqjfdOAQgGgeAYwiNeuRSaamoQ8Ihx8RLFpEnY5051agIAXC64XOuwbh1wNBisq87hQhSfxguxeO9Zyq3izxksJS4hhKf685TOa2XQf6G8/djtCqIvFsRYeARer7apwbxpptA0kUQ1ELgghJ7S9R1IEI8GF2/mVWQa5zXzhhJA10FfgVjU9yzlVMZg4EBzK4BXgddmJJhWK+NvLrKhpUqbfAyIoYgHo+qG3MnZF4spzRjOVFNDdtNMsWmSbr5w7dYHgqWgkDTOdFRu/zFcJk0flf9wXQencpylcc9SLmXtQP6Mc6P8x1ODGI0br5PqZF5EUh10wV2L+kGdVCdncAxh6SD2xQC4dsNogMtC08SwDVw95iJWSBprGY9CAoAwhvqURFvXkiqiLZV7lsyVNxjsGFBGCh3B4DeznzZ++4UH4XnkSDlPocxMhtl571SG4cXQd69o/LSvFIZPrPMxeg4/HhEAIIhd98rNF6admgtMk+CY/qlZCeK99fUwmbE8QzULSWOtWB/uzcrVJYR9ncrDarphqUvlniVTZX4C+av4B/U5glf7lSkoHsSj334Q3d5GeO76N6zfNVR/Q0sdW7BdHavf6Ybb54PP59Y8nenFSEhIDQ3sdNrgdvvg88k/8tQInQi+UZ3TLyW1RBmLxZC7U7OYNEmPt0ewE063W1nfDbfNiT5onqquN3nvoTTraZwmCAJifU7YbJlp1hlUlofGdUNIl849SybK+wSy/BN5+oGMJ43ln43J7l3H8m5b7R/Tpx5TT5DC/InemVBScOmvW30yVkhmP1SbfoLU/OngfOsU/4RwcTRPvVrZX8FpkkzO7Bay0tol7E7OmF6rlXSsnAXdQ8lk0noaZ173TCg73eASkruNEjl1ToW/P5XCJ5DLy5ZIJJIAsGrVKssBZHZ2FudXXVto3JG/61j58zPN9dFJtezUO1izZo3pcmszO6ZnjZRXrY9rtyYMn01uehBCSYxYHuJSeJrU6yyas7OzC7yHrKax8Xqp/Rc0Y23t3bP50pEWprJDSxfhtNXWPiS1M210yaWehs3fqZmp8DSphQypHPJeV9FpbHH/xlst3nuWDPHLbWgBJIi78j8NSwvBNKbKYDCgoknivZBHKZbraVhiGlOl8AnkJU+CFJ6xMuUbACe8GIKt8yhciKWGdQqhkbqcDK5mhX1MY6o4BoMlbwZDnerY8zxcuzHzCAA1k3IJ2P3UiMksl7QwTGOqrMqOJqpD+UYTEeXDUTClwXQsL/YZEBFRumbw3nvvVftciIhyYs2gfFJ9BoU0+yw79Q4c/3quLCdUaxJ/+0cFNaER6Z06dYr3UAmcOnWq2qewqLGZiIiIGAyIiIjBgIiIwGBARERgMCAiIjAYEBERGAyIiAiLYW6iq1dC/Eoj9v14DuM512uEO9fyd+dzb09lppswz+mE1+qE+pKE8Iy6pRNer5XtKn08MiWF8djQm+gaeYhTdFdRXQcD9/pP4cnuy+DAGUwBOTLzlQg99Mmcsz5KL70FZ2S+5OdI+UgI++5DZ9Do3XNDCD2JEbPMVgrDd18nsjfNtV2lj0e5SGEf7usMYhwC1o6AwaCK6rKZyL2+CaFvfQ6Huy+zdvNc3Qin8qc0N2/4Y20KZyotCY/d6lQyZjfcgggxFIIoCEotbhzBTqfhl8QDYficasbshiCGEBJFCO5c21X6eGRGCj8G3602ODuDrJHXiNTcRL899zHLG1VrOgr3+k/hcPdlqf+lOcDRBABn4Bv4jfk0zFc3YeahK+CYO4lbf5inOUmH01GUk5w579sewpMPeXWBXULY50RnEAAEhJKZ8/mHfTZ5mVvEzGFt80Ku7Sp9PBmno0iTwj44O9OfVLcbGB8HzNJOi+lYXoY1g5amxkqfhzWrV8i/587gsWfegvPFM9a2u3oFq581quvJJA5nZcwA4IC3X1RK7K/jTUm7LIwxJT8RHta3M2u3C2JMV1qv9PFI583X5d9uAWJoBocfFqp7PpRi2kxUkwHhxEn4HnsLth/+Bv7XimjfP8FO4tqS50vXHWtxAwBgHFPadjz1C+Ih4E6joqSjC9uV0QLBjNy50sejLGsfRmhmBsnDI3iIfSw1JWefQa0FhPHXTiP4buFBwK3WKKhOudHqTP8XThXT7zRpVnCgS82dX38TkuE6tXS8pcPh9VoftUUVlbcDudYCwkJIJzhaqK6kSuQ3YG0q/5DSLQ3aHNvM+JT1wQGVPh5RDbE0tLSlqRHTc/Wbkd6wWg5ojts/i+TtmgVz8wi/eBydxTQ5UZmF4VM6Gt1if8FfBu9YewNyDTau/vGIaovloaWLqYaQ0tQIb/dnkfxWU+4H0qiypDB8t3bKpXS3gIcf0jYrzGBKyXNvWFui5oZKH4+oBll+6KyeawbBH/8ie9jp1SshfuUKPHR9I9B0BQ7fMw/bj09X4/RII/0QEgC3gNDh3MMN6+14RLXKUs2gngOBqXdPw//jt+A7pvx//RUQr67qGS1xEsK+W1MPIbmFEGYMM2YnWlN9tQvpqq308YhqW95gsCgDgUbwJyeV0R+NWMtgUCWZTwYLoRkcHjF6FqCAPaZ7fZHd7Vvp4xHVvpzBYLEHAgDAu5yKorrC8N3qhF8uniM0czjPHD8OrJUfBsD4lPk7N5Nu6Ndl8pU+HlF9MA0GSyIQUNWFfcp8P25RbqaxkJM6W/ON6TcfDlrp4xHVC8NgsJQCgdtzhdJOfAZjr1X5ZJYa6TF8T53T57D16YsdXdvl0V/jfgwZPfArHcI+ZUK57V2avVb6eER1pC5nLS3MSoielYZDR93rP4Unb5eHzEovvWc+0R2VhXRonzKKp8B2dsdDUKe0CXb6kJk/S3jsPr+8X+FhaEeJVvp4RPWkrr/PwKq1t38Sh2//JKS5M5g5Ib/mvF4z/fXcSdzH7zKouFQ7+7gfTps/98q62UK9IyEIwU4EEUSn7XW4hRtwA17H68Hx9DDRkcyxQZU+HlE9WQLBYB5vzgHeJsDRdJky5XV6Wfilk/he5DSfHa07XozMhID7OhEcH8e4mikDcAsiniz5t2ZV+nhElVVX32ewMI1wXw3g6kbc8O48Xsc8xt/NvxW/z6AeSJCUnl1HRSZBK+x4nIe/NJiO5bUEagYqJfPndx0vQnmmpq774xGV3xLoQCYionwYDIiIiMGAiIgYDIiICAwGREQEBgMiIoLmOYP33nuvoA2vvPLKspwQEZEZPmdQPqlgwEQmIlq62ExEREQMBkRExGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIjAYEBERGAyIiAgMBkREBAYDIiICgwEREYHBgIiIwGBARERgMCAiIgD/DzAfRrLRsqvnAAAAAElFTkSuQmCC" alt="image-20200617091042921"></p> <p>数据库中并没有termId=16的数据，<strong>那么数据库的事务是回滚了，而消息是投放成功的，并没有保持原子性啊</strong>。那么为什么在执行executeLocalTransaction方法时，能够查询到termId=16的数据呢？**还记得MySQL的事务隔离级别吗？忘了的赶快复习一下吧。**在事务提交前，我们是可以查询到termId=16的数据的，所以消息提交了，看看消费端的情况，</p> <div class="language-shell extra-class"><pre class="language-shell"><code>msgs.size<span class="token punctuation">(</span><span class="token punctuation">)</span>:1
this is transaction mq Wed Jun <span class="token number">17</span> 09:07:15 CST <span class="token number">2020</span>
</code></pre></div><p>消息也正常消费了，这明显不符合我们的要求，我们如果在微服务之间使用这种方式保证数据的最终一致性，肯定会有大麻烦的。那我们该怎么使用s呢？我们可以在executeLocalTransaction方法中，固定返回UNKNOW，数据插入数据库成功也好，失败也罢，我们都返回UNKNOW。那么这个消息是否投放到队列中，就由checkLocalTransaction决定了。checkLocalTransaction肯定在sendTransactionMQ后执行，而且和sendTransactionMQ不在同一事务中。我们改一下程序吧，</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其他的地方不用改，我们再发送一下消息，</p> <div class="language-shell extra-class"><pre class="language-shell"><code>sendResult:UNKNOW 时间：Wed Jun <span class="token number">17</span> 09:56:59 CST <span class="token number">2020</span>
java.lang.Exception: 数据库事务异常

checkLocalTransaction <span class="token assign-left variable">termId</span><span class="token operator">=</span><span class="token number">18</span> term:null
checkLocalTransaction：ROLLBACK_MESSAGE
</code></pre></div><ul><li>事务消息发送的结果是UNKNOW，然后抛出异常，事务回滚；</li> <li>checkLocalTransaction方法，查询termId=18的数据，为null，消息再回滚；</li></ul> <p>又看了一下消费端，没有日志。数据库中也没有termId=18的数据，这才符合我们的预期，数据库插入不成功，消息投放不成功。我们再把抛出异常的代码注释掉，看看能不能都成功。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendTransactionMQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    ……
    <span class="token comment">//throw new Exception(&quot;数据库事务异常&quot;);</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再执行一下发送端程序，日志如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>sendResult:UNKNOW 时间：Wed Jun <span class="token number">17</span> <span class="token number">10</span>:02:57 CST <span class="token number">2020</span>
checkLocalTransaction <span class="token assign-left variable">termId</span><span class="token operator">=</span><span class="token number">19</span> term:com.example.rocketmqdemo.entity.Term@3b643475
checkLocalTransaction：COMMIT_MESSAGE
</code></pre></div><ul><li>发送结果返回UNKNOW；</li> <li>checkLocalTransaction方法查询termId=19的数据，能够查到；</li> <li>返回COMMIT_MESSAGE，消息提交到队列中；</li></ul> <p>先看看数据库中的数据吧，</p> <p><img src="/assets/img/image-20200617100601213.6970b765.png" alt="image-20200617100601213"></p> <p>termId=19的数据入库成功了，再看看消费端的日志，</p> <div class="language-shell extra-class"><pre class="language-shell"><code>msgs.size<span class="token punctuation">(</span><span class="token punctuation">)</span>:1
this is transaction mq Wed Jun <span class="token number">17</span> <span class="token number">10</span>:02:56 CST <span class="token number">2020</span>
</code></pre></div><p>消费成功，这才符合我们的预期。数据插入数据库成功，消息投放队列成功，消费消息成功。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>事务消息最重要的就是TransactionListener接口的实现，我们要理解executeLocalTransaction和checkLocalTransaction这两个方法是干什么用的，以及它们的执行时间。再一个就是和数据库事务的结合，数据库事务的隔离级别大家要知道。把上面这几点掌握了，就可以灵活的使用RocketMQ的事务消息了。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/article/rocketmq-6.html" class="prev">
        RocketMQ系列（六）批量发送与过滤
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.16ffb530.js" defer></script><script src="/assets/js/2.2805d820.js" defer></script><script src="/assets/js/14.fe8172bf.js" defer></script>
  </body>
</html>
