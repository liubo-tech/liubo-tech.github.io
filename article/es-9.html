<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES7学习笔记（九）搜索 | 牛初九博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="Java 技术 互联网 Spring Redis Mysql ">
    <meta name="keywords" content="Java 技术 互联网 Spring SpringBoot SpringCloud Elastic Search MySQL MyCAT 分布式 集群">
    
    <link rel="preload" href="/assets/css/0.styles.fab77d47.css" as="style"><link rel="preload" href="/assets/js/app.16ffb530.js" as="script"><link rel="preload" href="/assets/js/2.2805d820.js" as="script"><link rel="preload" href="/assets/js/46.9601296c.js" as="script"><link rel="prefetch" href="/assets/js/10.7af0fa3b.js"><link rel="prefetch" href="/assets/js/11.bf2b4ef3.js"><link rel="prefetch" href="/assets/js/12.ffa316c1.js"><link rel="prefetch" href="/assets/js/13.7bf9e28b.js"><link rel="prefetch" href="/assets/js/14.fe8172bf.js"><link rel="prefetch" href="/assets/js/15.12492866.js"><link rel="prefetch" href="/assets/js/16.1e0b9828.js"><link rel="prefetch" href="/assets/js/17.5274e857.js"><link rel="prefetch" href="/assets/js/18.14c495e2.js"><link rel="prefetch" href="/assets/js/19.0065f7d5.js"><link rel="prefetch" href="/assets/js/20.15195b8f.js"><link rel="prefetch" href="/assets/js/21.a49d2486.js"><link rel="prefetch" href="/assets/js/22.7625f3ea.js"><link rel="prefetch" href="/assets/js/23.6829be75.js"><link rel="prefetch" href="/assets/js/24.d89bf6ba.js"><link rel="prefetch" href="/assets/js/25.f9c8e982.js"><link rel="prefetch" href="/assets/js/26.df00cb25.js"><link rel="prefetch" href="/assets/js/27.c2c39573.js"><link rel="prefetch" href="/assets/js/28.9d6955a7.js"><link rel="prefetch" href="/assets/js/29.793a5925.js"><link rel="prefetch" href="/assets/js/3.99170183.js"><link rel="prefetch" href="/assets/js/30.1d4eb018.js"><link rel="prefetch" href="/assets/js/31.c3635b83.js"><link rel="prefetch" href="/assets/js/32.39f76767.js"><link rel="prefetch" href="/assets/js/33.9623bd00.js"><link rel="prefetch" href="/assets/js/34.685b37ce.js"><link rel="prefetch" href="/assets/js/35.b6d262de.js"><link rel="prefetch" href="/assets/js/36.706cce0c.js"><link rel="prefetch" href="/assets/js/37.4b559cf9.js"><link rel="prefetch" href="/assets/js/38.8440f0a1.js"><link rel="prefetch" href="/assets/js/39.89829fe9.js"><link rel="prefetch" href="/assets/js/4.44e35b71.js"><link rel="prefetch" href="/assets/js/40.1eae592a.js"><link rel="prefetch" href="/assets/js/41.307e59e5.js"><link rel="prefetch" href="/assets/js/42.9c9598a9.js"><link rel="prefetch" href="/assets/js/43.6de9381c.js"><link rel="prefetch" href="/assets/js/44.0bda172b.js"><link rel="prefetch" href="/assets/js/45.7bd4678e.js"><link rel="prefetch" href="/assets/js/47.8279d007.js"><link rel="prefetch" href="/assets/js/48.e8ae43c5.js"><link rel="prefetch" href="/assets/js/49.088eb890.js"><link rel="prefetch" href="/assets/js/5.7b7d1525.js"><link rel="prefetch" href="/assets/js/50.a104d084.js"><link rel="prefetch" href="/assets/js/51.0c101ee6.js"><link rel="prefetch" href="/assets/js/52.4269f250.js"><link rel="prefetch" href="/assets/js/53.1c55a938.js"><link rel="prefetch" href="/assets/js/54.dab6fc62.js"><link rel="prefetch" href="/assets/js/55.18a1bf4c.js"><link rel="prefetch" href="/assets/js/56.b2c0ee59.js"><link rel="prefetch" href="/assets/js/57.0a78afcc.js"><link rel="prefetch" href="/assets/js/58.d75522d5.js"><link rel="prefetch" href="/assets/js/59.2543ea7e.js"><link rel="prefetch" href="/assets/js/6.6d27b31c.js"><link rel="prefetch" href="/assets/js/60.16f65788.js"><link rel="prefetch" href="/assets/js/61.d6e2d8b6.js"><link rel="prefetch" href="/assets/js/62.183c4095.js"><link rel="prefetch" href="/assets/js/63.920617f0.js"><link rel="prefetch" href="/assets/js/64.5b2731e6.js"><link rel="prefetch" href="/assets/js/65.56420cc0.js"><link rel="prefetch" href="/assets/js/66.2ebd0c92.js"><link rel="prefetch" href="/assets/js/67.a414b285.js"><link rel="prefetch" href="/assets/js/68.989dacce.js"><link rel="prefetch" href="/assets/js/69.79a844b9.js"><link rel="prefetch" href="/assets/js/7.fee5c0b2.js"><link rel="prefetch" href="/assets/js/70.b789f7cb.js"><link rel="prefetch" href="/assets/js/71.90a71409.js"><link rel="prefetch" href="/assets/js/72.0dee4533.js"><link rel="prefetch" href="/assets/js/73.72b757a5.js"><link rel="prefetch" href="/assets/js/74.5cc6a8e7.js"><link rel="prefetch" href="/assets/js/75.a3efa729.js"><link rel="prefetch" href="/assets/js/76.ee52fbb0.js"><link rel="prefetch" href="/assets/js/77.2c257317.js"><link rel="prefetch" href="/assets/js/78.831d9b7b.js"><link rel="prefetch" href="/assets/js/79.7940520a.js"><link rel="prefetch" href="/assets/js/8.7f9f9c54.js"><link rel="prefetch" href="/assets/js/80.2f951622.js"><link rel="prefetch" href="/assets/js/81.fb674315.js"><link rel="prefetch" href="/assets/js/82.b9069b51.js"><link rel="prefetch" href="/assets/js/83.d718aedc.js"><link rel="prefetch" href="/assets/js/84.95180f04.js"><link rel="prefetch" href="/assets/js/85.3253eaff.js"><link rel="prefetch" href="/assets/js/86.3663d770.js"><link rel="prefetch" href="/assets/js/87.0c11349f.js"><link rel="prefetch" href="/assets/js/88.f5fac9dc.js"><link rel="prefetch" href="/assets/js/89.5e9c86e8.js"><link rel="prefetch" href="/assets/js/9.759c07c6.js"><link rel="prefetch" href="/assets/js/90.faeb161a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fab77d47.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">牛初九博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/gzh/gzh.html" class="nav-link">
  公众号
</a></div><div class="nav-item"><a href="/es/es.html" class="nav-link">
  ES系列
</a></div><div class="nav-item"><a href="/rocket/rocket.html" class="nav-link">
  RocketMQ系列
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="慕课课程" class="dropdown-title"><span class="title">慕课课程</span> <span class="arrow down"></span></button> <button type="button" aria-label="慕课课程" class="mobile-dropdown-title"><span class="title">慕课课程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://coding.imooc.com/class/341.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  精讲分布式定时任务
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://class.imooc.com/sale/javaarchitect" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java架构师直通车
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/gzh/gzh.html" class="nav-link">
  公众号
</a></div><div class="nav-item"><a href="/es/es.html" class="nav-link">
  ES系列
</a></div><div class="nav-item"><a href="/rocket/rocket.html" class="nav-link">
  RocketMQ系列
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="慕课课程" class="dropdown-title"><span class="title">慕课课程</span> <span class="arrow down"></span></button> <button type="button" aria-label="慕课课程" class="mobile-dropdown-title"><span class="title">慕课课程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://coding.imooc.com/class/341.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  精讲分布式定时任务
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://class.imooc.com/sale/javaarchitect" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java架构师直通车
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/article/nacos.html" class="sidebar-link">注册中心Nacos集群搭建</a></li><li><a href="/article/nacos-1.html" class="sidebar-link">Nacos配置中心和服务的注册发现</a></li><li><a href="/article/login.html" class="sidebar-link">怎样实现登录？| Cookie or JWT</a></li><li><a href="/article/oauth.html" class="sidebar-link">OAuth授权</a></li><li><a href="/article/sso.html" class="sidebar-link">SSO单点登录流程</a></li><li><a href="/article/front-back.html" class="sidebar-link">前后端分离 | 登录状态</a></li><li><a href="/article/MySQL+Keepalived.html" class="sidebar-link">MySQL+Keepalived高可用</a></li><li><a href="/article/mysql-ms.html" class="sidebar-link">MySQL主从同步配置</a></li><li><a href="/article/mysql-huan.html" class="sidebar-link">MySQL中的幻读，你真的理解吗？</a></li><li><a href="/article/db-pool.html" class="sidebar-link">数据库连接池数量设置为多少？</a></li><li><a href="/article/CSRF.html" class="sidebar-link">CSRF的原理与防御</a></li><li><a href="/article/redis-lock.html" class="sidebar-link">Redis分布式锁</a></li><li><a href="/article/limit.html" class="sidebar-link">MySql分页查询慢</a></li><li><a href="/article/taglib.html" class="sidebar-link">自制权限框架（一）jsp标签</a></li><li><a href="/article/annotation.html" class="sidebar-link">自制权限框架（二）注解</a></li><li><a href="/article/jmeter-1.html" class="sidebar-link">JMeter测试（一）</a></li><li><a href="/article/jmeter-2.html" class="sidebar-link">JMeter测试（二）</a></li><li><a href="/article/spring-security.html" class="sidebar-link">Spring Security实现RBAC权限管理</a></li><li><a href="/article/nginx1.html" class="sidebar-link">Nginx简介（一）</a></li><li><a href="/article/nginx2.html" class="sidebar-link">Nginx简介（二）</a></li><li><a href="/article/string.html" class="sidebar-link">String是值传递还是引用传递</a></li><li><a href="/article/redis-cluster.html" class="sidebar-link">Redis集群</a></li><li><a href="/article/cas.html" class="sidebar-link">CAS与OAuth2的区别</a></li><li><a href="/article/spring-eureka-2.html" class="sidebar-link">Eureka服务注册与发现</a></li><li><a href="/article/spring-mobile.html" class="sidebar-link">Spring Mobile</a></li><li><a href="/article/es-1.html" class="sidebar-link">ES学习（一）ES的安装与启动</a></li><li><a href="/article/es-2.html" class="sidebar-link">ES学习（二）ES的集群原理</a></li><li><a href="/article/es-3.html" class="sidebar-link">ES学习（三）新建索引</a></li><li><a href="/article/es-4.html" class="sidebar-link">ES学习（四）字段类型（mapping）</a></li><li><a href="/article/es-5.html" class="sidebar-link">ES学习（五）动态映射</a></li><li><a href="/article/es-6.html" class="sidebar-link">ES学习（六）分析器</a></li><li><a href="/article/es-7.html" class="sidebar-link">ES学习（七）IK中文分词器</a></li><li><a href="/article/es-8.html" class="sidebar-link">ES学习（八）数据的增删改</a></li><li><a href="/article/es-9.html" aria-current="page" class="active sidebar-link">ES学习（九）搜索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/es-9.html#分数-score" class="sidebar-link">分数（score）</a></li><li class="sidebar-sub-header"><a href="/article/es-9.html#查询-query-context" class="sidebar-link">查询（query context）</a></li><li class="sidebar-sub-header"><a href="/article/es-9.html#过滤-filter-context" class="sidebar-link">过滤（filter context）</a></li><li class="sidebar-sub-header"><a href="/article/es-9.html#组合查询" class="sidebar-link">组合查询</a></li><li class="sidebar-sub-header"><a href="/article/es-9.html#最后" class="sidebar-link">最后</a></li></ul></li><li><a href="/article/es-10.html" class="sidebar-link">ES学习（十）聚合查询</a></li><li><a href="/article/es-11.html" class="sidebar-link">ES学习（十一）与SpringBoot结合</a></li><li><a href="/article/es-12.html" class="sidebar-link">ES学习（十二）高亮 和 搜索建议</a></li><li><a href="/article/es-13.html" class="sidebar-link">ES学习（十三）GEO位置搜索</a></li><li><a href="/article/rocketmq-1.html" class="sidebar-link">RocketMQ系列（一）基本概念</a></li><li><a href="/article/rocketmq-2.html" class="sidebar-link">RocketMQ系列（二）环境搭建</a></li><li><a href="/article/rocketmq-3.html" class="sidebar-link">RocketMQ系列（三）消息的生产与消费</a></li><li><a href="/article/rocketmq-4.html" class="sidebar-link">RocketMQ系列（四）顺序消费</a></li><li><a href="/article/rocketmq-5.html" class="sidebar-link">RocketMQ系列（五）广播与延迟消息</a></li><li><a href="/article/rocketmq-6.html" class="sidebar-link">RocketMQ系列（六）批量发送与过滤</a></li><li><a href="/article/rocketmq-7.html" class="sidebar-link">RocketMQ系列（七）事务消息</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="es7学习笔记-九-搜索"><a href="#es7学习笔记-九-搜索" class="header-anchor">#</a> ES7学习笔记（九）搜索</h1> <p>搜索是ES最最核心的内容，没有之一。前面章节的内容，索引、动态映射、分词器等都是铺垫，最重要的就是最后点击搜索这一下。下面我们就看看点击搜索这一下的背后，都做了哪些事情。</p> <h2 id="分数-score"><a href="#分数-score" class="header-anchor">#</a> 分数（score）</h2> <p>ES的搜索结果是按照相关分数的高低进行排序的，咦？！ 怎么没说搜索先说搜索结果的排序了？咱们这里先把这个概念提出来，因为在搜索的过程中，会计算这个分数。这个分数代表了这条记录匹配搜索内容的相关程度。分数是一个浮点型的数字，对应的是搜索结果中的<code>_score</code>字段，分数越高代表匹配度越高，排序越靠前。</p> <p>在ES的搜索当中，分为两种，一种计算分数，而另外一种是不计算分数的。</p> <h2 id="查询-query-context"><a href="#查询-query-context" class="header-anchor">#</a> 查询（query context）</h2> <p>查询，代表的是这条记录与搜索内容匹配的怎么样，除了决定这条记录是否匹配外，还要计算这条记录的相关分数。这个和咱们平时的查询是一样的，比如我们搜索一个关键词，分词以后匹配到相关的记录，这些相关的记录都是查询的结果，那这些结果谁排名靠前，谁排名靠后呢？这个就要看匹配的程度，也就是计算的分数。</p> <h2 id="过滤-filter-context"><a href="#过滤-filter-context" class="header-anchor">#</a> 过滤（filter context）</h2> <p>过滤，代表的含义非常的简单，就是YES or NO，这条记录是否匹配查询条件，<strong>它不会计算分数</strong>。频繁使用的过滤还会被ES加入到缓存，以提升ES的性能。下面我们看一个查询和过滤的例子，这个也是ES官网中的例子。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> 
    <span class="token string">&quot;bool&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> 
      <span class="token string">&quot;must&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;title&quot;</span><span class="token builtin class-name">:</span>   <span class="token string">&quot;Search&quot;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span>,
        <span class="token punctuation">{</span> <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Elasticsearch&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span> 
        <span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span>  <span class="token punctuation">{</span> <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;published&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
        <span class="token punctuation">{</span> <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;publish_date&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2015-01-01&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看一下请求的路径<code>/_search</code>，这个是请求的路径，而请求的方法是<code>GET</code>，我们再看请求体中，有一个<code>query</code>，这个代表着查询的条件。而<code>bool</code>中的<code>must</code>被用作<code>query context</code>，它在查询的时候会计算记录匹配的相关分数。<code>filter</code>中的条件用作过滤，只会把符合条件的记录检索出来，不会计算分数。</p> <h2 id="组合查询"><a href="#组合查询" class="header-anchor">#</a> 组合查询</h2> <p>组合查询包含了其他的查询，像我们前面提到的<code>query context</code>和<code>filter context</code>。在组合查询中，分为很多种类型，我们挑重点的类型给大家介绍一下。</p> <h3 id="boolean-query"><a href="#boolean-query" class="header-anchor">#</a> Boolean Query</h3> <p>boolean查询，前面我们写的查询语句就是一个boolean查询，boolean查询中有几个关键词，表格如下：</p> <table><thead><tr><th>关键词</th> <th>描述</th></tr></thead> <tbody><tr><td>must</td> <td>必须满足的条件，而且会计算分数，</td></tr> <tr><td>filter</td> <td>必须满足的条件，不会计算分数</td></tr> <tr><td>should</td> <td>可以满足的条件，会计算分数</td></tr> <tr><td>must_not</td> <td>必须不满足的条件，不会计算分数</td></tr></tbody></table> <p>我们看看下面的查询语句：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST _search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bool&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;must&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;user&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;kimchy&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;tag&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;tech&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;must_not&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;range&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;gte&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>, <span class="token string">&quot;lte&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">20</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;should&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;tag&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;wow&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span> <span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;tag&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;elasticsearch&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;minimum_should_match&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">&quot;boost&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1.0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的查询是一个典型的boolean组合查询，里边的关键词都用上了。很多小伙伴们可能对<code>must</code>和<code>should</code>的区别不是很了解，<code>must</code>是必须满足的条件，我们的例子中<code>must</code>里只写了一个条件，如果是多个条件，那么里边的所有条件必须满足。而<code>should</code>就不一样了，<code>should</code>里边现在列出了两个条件，并不是说这两个条件必须满足，到底需要满足几个呢？我们看一下下面的关键字<code>minimum_should_match</code>，从字面上我们就可以看出它的含义，最小<code>should</code>匹配数，在这里设置的是1，也就是说，<code>should</code>里的条件只要满足1个，就算匹配成功。在boolean查询中，如果存在一个<code>should</code>条件，而没有<code>filter</code>和<code>must</code>条件的话，那么<code>minimum_should_match</code>的默认值是1，其他情况默认值是0。</p> <p>我们再看一个实际的例子吧，还记得前面我们创建的<code>ik_index</code>索引吗？索引中存在着几条数据，数据如下：</p> <table><thead><tr><th style="text-align:left;">_index</th> <th style="text-align:left;">_type</th> <th style="text-align:left;">_id</th> <th style="text-align:left;">▲_score</th> <th style="text-align:left;">id</th> <th style="text-align:left;">title</th> <th style="text-align:left;">desc</th></tr></thead> <tbody><tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">fEsN-HEBZl0Dh1ayKWZb</td> <td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">苹果</td> <td style="text-align:left;">苹果真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">2</td> <td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">香蕉</td> <td style="text-align:left;">香蕉真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">香蕉</td> <td style="text-align:left;">香蕉真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">3</td> <td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">橘子</td> <td style="text-align:left;">橘子真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">4</td> <td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">桃子</td> <td style="text-align:left;">桃子真好吃</td></tr></tbody></table> <p>只有5条记录，我们新建一个查询语句，如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST /ik_index/_search
<span class="token punctuation">{</span>
    <span class="token string">&quot;query&quot;</span>:<span class="token punctuation">{</span>
        <span class="token string">&quot;bool&quot;</span>:<span class="token punctuation">{</span>
            <span class="token string">&quot;must&quot;</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;match&quot;</span>:<span class="token punctuation">{</span>
                        <span class="token string">&quot;desc&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;香蕉好吃&quot;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;from&quot;</span>:0,
    <span class="token string">&quot;size&quot;</span>:10,
<span class="token punctuation">}</span>
</code></pre></div><p>我们查询的条件是<code>desc</code>字段满足<code>香蕉好吃</code>，由于我们使用的ik分词器，查询条件<code>香蕉好吃</code>会被分词为<code>香蕉</code>和<code>好吃</code>，但是5的数据的desc中都有<code>好吃</code>字段，所有5条数据都会被查询出来，我们执行一下，看看结果：</p> <table><thead><tr><th style="text-align:left;">_index</th> <th style="text-align:left;">_type</th> <th style="text-align:left;">_id</th> <th style="text-align:left;">▲_score</th> <th style="text-align:left;">id</th> <th style="text-align:left;">title</th> <th style="text-align:left;">desc</th></tr></thead> <tbody><tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">2</td> <td style="text-align:left;">0.98773474</td> <td style="text-align:left;">1</td> <td style="text-align:left;">香蕉</td> <td style="text-align:left;">香蕉真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">1</td> <td style="text-align:left;">0.98773474</td> <td style="text-align:left;">1</td> <td style="text-align:left;">香蕉</td> <td style="text-align:left;">香蕉真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">3</td> <td style="text-align:left;">0.08929447</td> <td style="text-align:left;">1</td> <td style="text-align:left;">橘子</td> <td style="text-align:left;">橘子真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">4</td> <td style="text-align:left;">0.08929447</td> <td style="text-align:left;">1</td> <td style="text-align:left;">桃子</td> <td style="text-align:left;">桃子真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">fEsN-HEBZl0Dh1ayKWZb</td> <td style="text-align:left;">0.07893815</td> <td style="text-align:left;">1</td> <td style="text-align:left;">苹果</td> <td style="text-align:left;">苹果真好吃</td></tr></tbody></table> <p>哈哈，5条数据全部查询出来了，和我们的预期是一样的，但是，我们需要注意一点的是<code>_score</code>字段，它们的分数是不一样的，我们的查询条件是<code>香蕉好吃</code>，所以既包含<code>香蕉</code>又包含<code>好吃</code>的数据分数高，我们看到分数到了0.98，而另外3条数据只匹配了<code>好吃</code>，所以分数只有0.7，0.8。</p> <h3 id="boosting-query"><a href="#boosting-query" class="header-anchor">#</a> Boosting Query</h3> <p>这个查询比较有意思，它有两个关键词<code>positive</code>和<code>negative</code>，<code>positive</code>是“正”，所有满足<code>positive</code>条件的数据都会被查询出来，<code>negative</code>是“负”，<strong>满足<code>negative</code>条件的数据并不会被过滤掉</strong>，而是会<strong>扣减分数</strong>。那么扣减分数要扣减多少呢？这里边有另外一个字段<code>negative_boost</code>，这个字段是得分的系数，它的分数在0~1之间，满足了<code>negative</code>条件的数据，它们的分数会乘以这个系数，比如这个系数是0.5，原来100分的数据如果满足了<code>negative</code>条件，它的分数会乘以0.5，变成50分。我们看看下面的例子，</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST /ik_index/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;boosting&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;positive&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;desc&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;好吃&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;negative&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;desc&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;香蕉&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;negative_boost&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0.5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>positive</code>条件是好吃，只要<code>desc</code>中有“好吃”的数据都会被查询出来，而<code>negative</code>的条件是香蕉，只要<code>desc</code>中包含“香蕉”的数据都会被扣减分数，扣减多少分数呢？它的得分将会变为<code>原分数*0.5</code>。我们执行一下，看看效果，</p> <table><thead><tr><th style="text-align:left;">index</th> <th style="text-align:left;">type</th> <th style="text-align:left;">_id</th> <th style="text-align:left;">score</th> <th style="text-align:left;">_source.id</th> <th style="text-align:left;">source.title</th> <th style="text-align:left;">source.desc</th></tr></thead> <tbody><tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">3</td> <td style="text-align:left;">0.08929447</td> <td style="text-align:left;">1</td> <td style="text-align:left;">橘子</td> <td style="text-align:left;">橘子真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">4</td> <td style="text-align:left;">0.08929447</td> <td style="text-align:left;">1</td> <td style="text-align:left;">桃子</td> <td style="text-align:left;">桃子真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">fEsN-HEBZl0Dh1ayKWZb</td> <td style="text-align:left;">0.07893815</td> <td style="text-align:left;">1</td> <td style="text-align:left;">苹果</td> <td style="text-align:left;">苹果真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">2</td> <td style="text-align:left;">0.044647235</td> <td style="text-align:left;">1</td> <td style="text-align:left;">香蕉</td> <td style="text-align:left;">香蕉真好吃</td></tr> <tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">1</td> <td style="text-align:left;">0.044647235</td> <td style="text-align:left;">1</td> <td style="text-align:left;">香蕉</td> <td style="text-align:left;">香蕉真好吃</td></tr></tbody></table> <p>我们可以看到前3条数据的分数都在0.09左右，而后两条的数据在0.044左右，很显然，后两条数据中的<code>desc</code>包含<code>香蕉</code>，它们的得分会乘以0.5的系数，所以分数只有前面数据的分数的一半。</p> <h3 id="全文检索"><a href="#全文检索" class="header-anchor">#</a> 全文检索</h3> <p>在前面几节的内容中，我们介绍过，只有字段的类型是<code>text</code>，才会使用全文检索，全文检索会使用到分析器，在我们的<code>ik_index</code>索引中，<code>title</code>和<code>desc</code>字段都是text类型，所以，这两个字段的搜索都会使用到ik中文分词器。全文检索比起前面的组合检索要简单一点，当然，在ES的官方文档中，全文检索中的内容还是挺多的，在这里我们只介绍一个标准的全文检索。</p> <p>我们看看下面的语句，</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST /ik_index/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;desc&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;苹果&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在请求体中，<code>match</code>代替了之前的<code>bool</code>，<code>match</code>是标准的全文索引的查询。<code>match</code>后面跟的字段是要查询的字段名，在咱们的例子中，查询的字段是<code>desc</code>，如果有多个字段，可以列举多个。<code>desc</code>字段里，<code>query</code>就是要查询的内容。我们还可以在字段中指定分析器，使用<code>analyzer</code>关键字，如果不指定，默认就是索引的分析器。我们执行一下上面的查询，结果如下：</p> <table><thead><tr><th style="text-align:left;">index</th> <th style="text-align:left;">type</th> <th style="text-align:left;">_id</th> <th style="text-align:left;">score</th> <th style="text-align:left;">source.id</th> <th style="text-align:left;">source.title</th> <th style="text-align:left;">source.desc</th></tr></thead> <tbody><tr><td style="text-align:left;">ik_index</td> <td style="text-align:left;">_doc</td> <td style="text-align:left;">fEsN-HEBZl0Dh1ayKWZb</td> <td style="text-align:left;">1.2576691</td> <td style="text-align:left;">1</td> <td style="text-align:left;">苹果</td> <td style="text-align:left;">苹果真好吃</td></tr></tbody></table> <p>我们可以看到相应的数据已经检索出来了。</p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>在ES中，检索的花样是比较多的，这里也不能一一给大家介绍了，只介绍一些最基本、最常用的查询功能。下一篇我们看一下ES的聚合查询功能。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/article/es-8.html" class="prev">
        ES学习（八）数据的增删改
      </a></span> <span class="next"><a href="/article/es-10.html">
        ES学习（十）聚合查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.16ffb530.js" defer></script><script src="/assets/js/2.2805d820.js" defer></script><script src="/assets/js/46.9601296c.js" defer></script>
  </body>
</html>
